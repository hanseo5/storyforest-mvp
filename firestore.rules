rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // ── Users: only the owner can read/write their profile ──
    match /users/{userId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }

    // ── Books: official books readable by all, personal books only by author ──
    match /books/{bookId} {
      allow read: if request.auth != null
                  && (resource.data.isOfficial == true
                      || resource.data.authorId == request.auth.uid);
      allow create: if request.auth != null
                    && request.resource.data.authorId == request.auth.uid;
      allow update, delete: if request.auth != null
                            && resource.data.authorId == request.auth.uid;

      // Pages subcollection — follows parent book access
      match /pages/{pageId} {
        allow read: if request.auth != null
                    && (get(/databases/$(database)/documents/books/$(bookId)).data.isOfficial == true
                        || get(/databases/$(database)/documents/books/$(bookId)).data.authorId == request.auth.uid);
        allow write: if request.auth != null
                     && get(/databases/$(database)/documents/books/$(bookId)).data.authorId == request.auth.uid;
      }

      // Translations: readable if book is accessible, writable by authenticated users
      match /translations/{langId} {
        allow read, write: if request.auth != null;
      }
    }

    // ── Drafts: only the author can CRUD ──
    match /drafts/{draftId} {
      allow read: if request.auth != null
                  && resource.data.authorId == request.auth.uid;
      allow create: if request.auth != null
                    && request.resource.data.authorId == request.auth.uid;
      allow update, delete: if request.auth != null
                            && resource.data.authorId == request.auth.uid;

      match /pages/{pageId} {
        allow read, write: if request.auth != null
                           && get(/databases/$(database)/documents/drafts/$(draftId)).data.authorId == request.auth.uid;
      }
    }

    // ── Voices: only the owner ──
    match /voices/{voiceId} {
      allow read: if request.auth != null
                  && resource.data.userId == request.auth.uid;
      allow create: if request.auth != null
                    && request.resource.data.userId == request.auth.uid;
      allow update, delete: if request.auth != null
                            && resource.data.userId == request.auth.uid;
    }

    // ── User audio files: read own only, write from Cloud Functions only ──
    match /user_audio_files/{fileId} {
      allow read: if request.auth != null
                  && resource.data.userId == request.auth.uid;
      allow write: if false; // Only written by admin SDK (Cloud Functions)
    }

    // ── User settings: only the owner ──
    match /userSettings/{userId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }

    // ── Config: read-only, write only from admin SDK (Cloud Functions) ──
    match /config/{configId} {
      allow read: if request.auth != null;
      allow write: if false;
    }

    // ── Story generations: read own, write from Cloud Functions only ──
    match /story_generations/{genId} {
      allow read: if request.auth != null;
      allow write: if false; // Only written by admin SDK (Cloud Functions)
    }
  }
}
